#!/usr/bin/python

from argparse import ArgumentParser, ArgumentTypeError
from itertools import product
import os
import subprocess


# run the executable with given parameters
def run_with_parameters(p, n, d):
    # should be in the same directory as this file
    p = subprocess.Popen(['mpirun', '-np', str(p), './jacobi', '-n', str(n), '-d', str(d)],
                          stdout = subprocess.PIPE, stderr = subprocess.PIPE)
    # get output from stdout and stderr
    result, errors = p.communicate()
    # print out the result from stdout
    return float(errors.strip().split()[-1])

def processor(x):
    x = int(x)
    if x <= 0:
        raise ArgumentTypeError("invalid processor value: %d, not greater than 0"%(x,))
    return x

def size(x):
    x = int(x)
    if x <= 0:
        raise ArgumentTypeError("invalid size value: %d, not greater than 0"%(x,))
    return x

def difficulty(x):
    x = float(x)
    if x < 0.0 or x > 1.0:
        raise ArgumentTypeError("invalid difficulty value: %r, not in range [0.0, 1.0]"%(x,))
    return x

if __name__ == '__main__':
    parser = ArgumentParser()
    parser.add_argument("-p", help = "Number of processors to be used.", required = True,
                        type = processor, nargs = '+', metavar = 'PROCESSORS')
    parser.add_argument("-n", help = "Size of the input.", required = True,
                        type = size, nargs = '+', metavar = 'SIZE')
    parser.add_argument("-d", help = "Difficulty of the input.", required = True,
                        type = difficulty, nargs = '+', metavar = 'DIFFICULTY')
    parser.add_argument("--repeat", help = "Number of repetitions.",
                        type = int, default = 3, metavar = 'DIFFICULTY')
    args = parser.parse_args()

    print 'p\tn\td\tTime(s)'
    for params in product(args.p, args.n, args.d):
        time = 0.0
        for run in range(args.repeat):
            time += run_with_parameters(*params)
        time /= args.repeat
        result = list(params)
        result.append(time)
        print '%d\t%d\t%r\t%r'%tuple(result)
